{{ define "main" }}

<!-- Archive Hero -->
<section class="hero hero-archive">
  <div class="hero-bg" style="background-image: var(--overlay-gradient);"></div>
  <div class="hero-content">
    <h1 class="hero-title">필드노트 아카이브</h1>
    <p class="hero-sub">현장에서 얻은 모든 인사이트를 한 곳에서 만나보세요</p>
  </div>
  </section>

<!-- Controls: Chips + Search -->
<div class="archive-controls">
  <div class="chip-nav" role="tablist" aria-label="카테고리 필터">
    <a href="/archive/" class="chip active" data-cat="all" role="button" aria-pressed="true">전체</a>
    <a href="/market" class="chip market" data-cat="market" role="button" aria-pressed="false">시장 <span class="chip-emoji" aria-hidden="true">📊</span></a>
    <a href="/ops" class="chip ops" data-cat="ops" role="button" aria-pressed="false">운영 <span class="chip-emoji" aria-hidden="true">🛠️</span></a>
    <a href="/behind" class="chip behind" data-cat="behind" role="button" aria-pressed="false">비하인드 <span class="chip-emoji" aria-hidden="true">🟣</span></a>
    <a href="/story" class="chip story" data-cat="story" role="button" aria-pressed="false">스토리 <span class="chip-emoji" aria-hidden="true">💬</span></a>
  </div>
  <div class="searchbar">
    <input id="archiveSearch" type="search" placeholder="검색…" aria-label="아카이브 검색" />
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
  </div>
  </div>

<!-- Posts Grid -->
{{ $all := .Site.RegularPages.ByDate.Reverse }}
{{ $p := .Paginate $all }}

<div class="posts-grid" id="archiveGrid" aria-live="polite">
  {{ range $p.Pages }}
    {{ $category := .Params.category | default "story" }}
    {{ partial (printf "card-%s.html" $category) . }}
  {{ end }}
  </div>

{{ partial "pagination.html" . }}

<!-- Client-side search: 인덱스(fetch /index.json) 기반 전역 검색 -->
<script>
  (function(){
    const input = document.getElementById('archiveSearch');
    if(!input) return;
    const grid = document.getElementById('archiveGrid');
    const chips = Array.from(document.querySelectorAll('.chip-nav .chip'));
    const initial = grid.innerHTML;
    const labels = {market:'시장읽기',ops:'운영노트',behind:'비하인드',story:'이야기'};
    let index = null; let inflight = false;
    const state = { q: '', cat: 'all' };

    // Init from URL
    const params = new URLSearchParams(location.search);
    if(params.get('cat')) state.cat = params.get('cat');
    if(params.get('q')) { state.q = params.get('q'); input.value = state.q; }

    async function ensureIndex(){
      if(index || inflight) return;
      inflight = true;
      try { const res = await fetch('/search/index.json'); index = await res.json(); }
      catch(e){ /* noop */ } finally { inflight = false; }
    }
    function cardHtml(p){
      const cat = p.category || 'story';
      const catLabel = labels[cat] || '이야기';
      const tag = (p.tags && p.tags.length) ? ('<span class="tag">'+p.tags[0]+'</span>') : '';
      return (
        '<div class="card card-'+cat+'">'
        +'<div class="card-color-band"></div>'
        +'<div class="card-content">'
        +'<div class="card-category">'+catLabel+'</div>'
        +'<h3 class="card-title"><a href="'+p.url+'">'+p.title+'</a></h3>'
        +'<div class="card-summary">'+(p.summary||'')+'</div>'
        +'<div class="card-meta"><span class="date">'+p.date.replace(/-/g,'.')+'</span>'+tag+'</div>'
        +'</div></div>'
      );
    }
    function render(items){
      if(!items || items.length === 0){ grid.innerHTML = '<div class="empty">검색 결과가 없습니다.</div>'; return; }
      grid.innerHTML = items.map(cardHtml).join('');
    }
    function updateUrl(){
      const ps = new URLSearchParams();
      if(state.cat && state.cat !== 'all') ps.set('cat', state.cat);
      if(state.q && state.q.length >= 2) ps.set('q', state.q);
      const qs = ps.toString();
      history.replaceState(null, '', qs ? ('?'+qs) : location.pathname);
    }
    async function apply(){
      const needDynamic = (state.cat !== 'all') || (state.q.length >= 2);
      if(!needDynamic){ grid.innerHTML = initial; updateActive(); updateUrl(); return; }
      await ensureIndex();
      if(!index){ return; }
      const q = state.q.toLowerCase();
      let items = index;
      if(state.cat !== 'all') items = items.filter(p => (p.category||'story') === state.cat);
      if(state.q.length >= 2){
        items = items.filter(p => (
          (p.title||'').toLowerCase().includes(q) ||
          (p.summary||'').toLowerCase().includes(q) ||
          (p.tags||[]).join(' ').toLowerCase().includes(q)
        ));
      }
      render(items);
      updateActive();
      updateUrl();
    }
    function updateActive(){
      chips.forEach(c => {
        const on = (c.dataset.cat || 'all') === state.cat;
        c.classList.toggle('active', on);
        c.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    chips.forEach(c => c.addEventListener('click', function(ev){ ev.preventDefault(); state.cat = this.dataset.cat || 'all'; apply(); }));
    input.addEventListener('input', function(){ state.q = this.value.trim(); apply(); });

    // Apply initial state if any
    apply();
  })();
  </script>

{{ end }}
